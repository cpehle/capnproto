-- Generated by capnpc-lean4; DO NOT EDIT.
-- source: test/lean4/fixtures/capability.capnp

import Capnp.Runtime
import Capnp.Rpc

set_option maxHeartbeats 2000000


namespace Capnp.Gen.test.lean4.fixtures.capability

structure Small.Reader where
  struct : Capnp.StructReader

  deriving BEq

def Small.read (ptr : Capnp.AnyPointer) : Small.Reader := { struct := Capnp.readStruct ptr }
def Small.readChecked (ptr : Capnp.AnyPointer) : Except String Small.Reader := do
  let sr ← Capnp.readStructChecked ptr
  return { struct := sr }
def Small.fromStruct (sr : Capnp.StructReader) : Small.Reader := { struct := sr }

structure Small.Builder where
  struct : Capnp.StructBuilder

  deriving BEq

def Small.Builder.fromStruct (sb : Capnp.StructBuilder) : Small.Builder := { struct := sb }


structure CapHolder.Reader where
  struct : Capnp.StructReader

  deriving BEq

def CapHolder.read (ptr : Capnp.AnyPointer) : CapHolder.Reader := { struct := Capnp.readStruct ptr }
def CapHolder.readChecked (ptr : Capnp.AnyPointer) : Except String CapHolder.Reader := do
  let sr ← Capnp.readStructChecked ptr
  return { struct := sr }
def CapHolder.fromStruct (sr : Capnp.StructReader) : CapHolder.Reader := { struct := sr }

structure CapHolder.Builder where
  struct : Capnp.StructBuilder

  deriving BEq

def CapHolder.Builder.fromStruct (sb : Capnp.StructBuilder) : CapHolder.Builder := { struct := sb }


structure AnyHolder.Reader where
  struct : Capnp.StructReader

  deriving BEq

def AnyHolder.read (ptr : Capnp.AnyPointer) : AnyHolder.Reader := { struct := Capnp.readStruct ptr }
def AnyHolder.readChecked (ptr : Capnp.AnyPointer) : Except String AnyHolder.Reader := do
  let sr ← Capnp.readStructChecked ptr
  return { struct := sr }
def AnyHolder.fromStruct (sr : Capnp.StructReader) : AnyHolder.Reader := { struct := sr }

structure AnyHolder.Builder where
  struct : Capnp.StructBuilder

  deriving BEq

def AnyHolder.Builder.fromStruct (sb : Capnp.StructBuilder) : AnyHolder.Builder := { struct := sb }


abbrev Dummy := Capnp.Rpc.Client

namespace Dummy

def interfaceId : UInt64 := UInt64.ofNat 14600654945541569631

abbrev Handler := Capnp.Rpc.Handler

structure Server where
  unit : Unit := ()

def dispatch (server : Server) : Capnp.Rpc.Dispatch := Id.run do
  let mut d := Capnp.Rpc.Dispatch.empty
  let _ := server
  return d

def backend (server : Server)
    (onMissing : Capnp.Rpc.Client -> Capnp.Rpc.Method -> Capnp.Rpc.Payload -> IO Capnp.Rpc.Payload := fun _ _ _ => pure Capnp.emptyRpcEnvelope) : Capnp.Rpc.Backend :=
  (dispatch server).toBackend (onMissing := onMissing)

def registerTarget (runtime : Capnp.Rpc.Runtime) (server : Server)
    (onMissing : Capnp.Rpc.Client -> Capnp.Rpc.Method -> Capnp.Rpc.Payload -> IO Capnp.Rpc.Payload := fun _ _ _ => pure Capnp.emptyRpcEnvelope) : IO Dummy := do
  Capnp.Rpc.Runtime.registerDispatchTarget runtime (dispatch server) (onMissing := onMissing)

def registerTargetM (server : Server)
    (onMissing : Capnp.Rpc.Client -> Capnp.Rpc.Method -> Capnp.Rpc.Payload -> IO Capnp.Rpc.Payload := fun _ _ _ => pure Capnp.emptyRpcEnvelope) : Capnp.Rpc.RuntimeM Dummy := do
  Capnp.Rpc.RuntimeM.registerDispatchTarget (dispatch server) (onMissing := onMissing)

end Dummy

mutual
  structure Small where
    x : UInt32


  structure CapHolder where
    cap : Dummy
    caps : Array Dummy


  structure AnyHolder where
    any : Capnp.AnyPointer


end


def Small.Reader.getX (r : Small.Reader) : UInt32 := Capnp.getUInt32 r.struct 0
def Small.Reader.getXChecked (r : Small.Reader) : Except String (UInt32) := pure (Capnp.getUInt32 r.struct 0)
def Small.initRoot : Capnp.BuilderM Small.Builder := do
  let p ← Capnp.getRootPointer
  let sb ← Capnp.initStructPointer p 1 0
  return { struct := sb }

def Small.Builder.setX (b : Small.Builder) (v : UInt32) : Capnp.BuilderM Unit := do
  Capnp.setUInt32 b.struct 0 v


def CapHolder.Reader.getCap (r : CapHolder.Reader) : Dummy := Capnp.readCapability (Capnp.getPointer r.struct 0)
def CapHolder.Reader.getCapChecked (r : CapHolder.Reader) : Except String (Dummy) := Capnp.readCapabilityChecked (Capnp.getPointer r.struct 0)

def CapHolder.Reader.getCaps (r : CapHolder.Reader) : Capnp.ListReader Dummy := Capnp.readListCapabilityReader (Capnp.getPointer r.struct 1)
def CapHolder.Reader.getCapsChecked (r : CapHolder.Reader) : Except String (Capnp.ListReader Dummy) := do
  let r ← Capnp.readListPointerCheckedReader (Capnp.getPointer r.struct 1)
  return Capnp.ListReader.map Capnp.readCapability r
def CapHolder.Reader.hasCaps (r : CapHolder.Reader) : Bool := !Capnp.isNullPointer (Capnp.getPointer r.struct 1)

def CapHolder.initRoot : Capnp.BuilderM CapHolder.Builder := do
  let p ← Capnp.getRootPointer
  let sb ← Capnp.initStructPointer p 0 2
  return { struct := sb }

def CapHolder.Builder.setCap (b : CapHolder.Builder) (v : Capnp.Capability) : Capnp.BuilderM Unit := do
  Capnp.writeCapability (Capnp.getPointerBuilder b.struct 0) v

def CapHolder.Builder.clearCaps (b : CapHolder.Builder) : Capnp.BuilderM Unit := do
  Capnp.clearPointer (Capnp.getPointerBuilder b.struct 1)

def CapHolder.Builder.initCaps (b : CapHolder.Builder) (n : Nat) : Capnp.BuilderM (Array Capnp.AnyPointerBuilder) := do
  Capnp.writeListPointer (Capnp.getPointerBuilder b.struct 1) n
def CapHolder.Builder.setCaps (b : CapHolder.Builder) (v : Array Capnp.Capability) : Capnp.BuilderM Unit := do
  Capnp.writeListCapability (Capnp.getPointerBuilder b.struct 1) v


def AnyHolder.Reader.getAny (r : AnyHolder.Reader) : Capnp.AnyPointer := Capnp.getPointer r.struct 0
def AnyHolder.Reader.getAnyChecked (r : AnyHolder.Reader) : Except String (Capnp.AnyPointer) := Capnp.readAnyPointerChecked (Capnp.getPointer r.struct 0)
def AnyHolder.Reader.hasAny (r : AnyHolder.Reader) : Bool := !Capnp.isNullPointer (Capnp.getPointer r.struct 0)

def AnyHolder.initRoot : Capnp.BuilderM AnyHolder.Builder := do
  let p ← Capnp.getRootPointer
  let sb ← Capnp.initStructPointer p 0 1
  return { struct := sb }

def AnyHolder.Builder.clearAny (b : AnyHolder.Builder) : Capnp.BuilderM Unit := do
  Capnp.clearPointer (Capnp.getPointerBuilder b.struct 0)

def AnyHolder.Builder.getAny (b : AnyHolder.Builder) : Capnp.AnyPointerBuilder := Capnp.getPointerBuilder b.struct 0


mutual
  def Small.Builder.setFromValue (b : Small.Builder) (v : Small) : Capnp.BuilderM Unit := do
    b.setX v.x


  def CapHolder.Builder.setFromValue (b : CapHolder.Builder) (v : CapHolder) : Capnp.BuilderM Unit := do
    b.setCap v.cap
    Capnp.writeListCapability (Capnp.getPointerBuilder b.struct 1) (v.caps)


  def AnyHolder.Builder.setFromValue (b : AnyHolder.Builder) (v : AnyHolder) : Capnp.BuilderM Unit := do
    Capnp.copyAnyPointer (Capnp.getPointerBuilder b.struct 0) v.any


end


mutual
  def Small.ofReader (r : Small.Reader) : Small :=
    { x := r.getX
    }


  def CapHolder.ofReader (r : CapHolder.Reader) : CapHolder :=
    { cap := r.getCap
    , caps := Capnp.ListReader.toArray (r.getCaps)
    }


  def AnyHolder.ofReader (r : AnyHolder.Reader) : AnyHolder :=
    { any := r.getAny
    }


end

end Capnp.Gen.test.lean4.fixtures.capability
